<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>线程池管理系统</title>
    <link rel="stylesheet" href="${request.contextPath}/statics/css/bootstrap.min.css">
    <link rel="stylesheet" href="${request.contextPath}/statics/css/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }
        [v-cloak] { display: none; }

        /* Header */
        .page-header {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: #fff;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .page-header h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }
        .page-header h1 i { margin-right: 10px; }
        .header-info {
            font-size: 13px;
            opacity: 0.85;
        }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .header-actions .btn { font-size: 13px; padding: 6px 14px; }

        /* Container */
        .main-container { padding: 20px 30px; max-width: 1600px; margin: 0 auto; }

        /* Stat Cards */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .stat-icon {
            width: 48px; height: 48px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #fff;
        }
        .stat-icon.blue { background: linear-gradient(135deg, #1a73e8, #4a9af5); }
        .stat-icon.green { background: linear-gradient(135deg, #34a853, #5ec879); }
        .stat-icon.orange { background: linear-gradient(135deg, #f9a825, #fbc02d); }
        .stat-icon.red { background: linear-gradient(135deg, #ea4335, #f06292); }
        .stat-icon.purple { background: linear-gradient(135deg, #7b1fa2, #ab47bc); }
        .stat-icon.teal { background: linear-gradient(135deg, #00897b, #26a69a); }
        .stat-info { flex: 1; }
        .stat-value { font-size: 24px; font-weight: 700; color: #1a1a1a; line-height: 1.2; }
        .stat-label { font-size: 12px; color: #888; margin-top: 2px; }

        /* Panels */
        .panel {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .panel-header {
            padding: 14px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .panel-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }
        .panel-title i { margin-right: 8px; color: #1a73e8; }
        .panel-actions { display: flex; gap: 8px; align-items: center; }
        .panel-body { padding: 16px 20px; }
        .panel-body.no-padding { padding: 0; }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            background: #fafbfc;
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #eee;
            white-space: nowrap;
        }
        .data-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
            color: #444;
        }
        .data-table tbody tr:hover { background: #f8f9ff; }
        .data-table .no-data {
            text-align: center;
            padding: 40px;
            color: #aaa;
            font-size: 14px;
        }

        /* Status badges */
        .badge-status {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-running { background: #e3f2fd; color: #1565c0; }
        .badge-completed { background: #e8f5e9; color: #2e7d32; }
        .badge-failed { background: #fce4ec; color: #c62828; }
        .badge-skipped { background: #eceff1; color: #546e7a; }

        /* Config Form */
        .config-form { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
        .config-group { display: flex; flex-direction: column; gap: 4px; }
        .config-group label { font-size: 12px; color: #666; font-weight: 500; }
        .config-group input {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 7px 12px;
            font-size: 13px;
            width: 160px;
            outline: none;
            transition: border-color 0.2s;
        }
        .config-group input:focus { border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }

        /* Buttons */
        .btn-primary-custom {
            background: #1a73e8;
            color: #fff;
            border: none;
            padding: 7px 18px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary-custom:hover { background: #1557b0; }
        .btn-outline {
            background: transparent;
            color: #1a73e8;
            border: 1px solid #1a73e8;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-outline:hover { background: #1a73e8; color: #fff; }
        .btn-danger-outline {
            background: transparent;
            color: #ea4335;
            border: 1px solid #ea4335;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-danger-outline:hover { background: #ea4335; color: #fff; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }

        /* Search/Filter bar */
        .filter-bar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .filter-bar input, .filter-bar select {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            outline: none;
        }
        .filter-bar input:focus, .filter-bar select:focus {
            border-color: #1a73e8;
        }

        /* Pagination */
        .pagination-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-top: 1px solid #f0f0f0;
            font-size: 13px;
            color: #666;
        }
        .pagination-btns { display: flex; gap: 4px; }
        .pagination-btns button {
            border: 1px solid #ddd;
            background: #fff;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .pagination-btns button:hover { background: #f0f0f0; }
        .pagination-btns button.active { background: #1a73e8; color: #fff; border-color: #1a73e8; }
        .pagination-btns button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Charts */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-container { height: 260px; }

        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }
        .switch-input { display: none; }
        .switch-label {
            width: 40px; height: 22px;
            background: #ccc;
            border-radius: 11px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .switch-label::after {
            content: '';
            width: 18px; height: 18px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px; left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .switch-input:checked + .switch-label { background: #1a73e8; }
        .switch-input:checked + .switch-label::after { transform: translateX(18px); }

        /* Tabs */
        .tab-bar { display: flex; border-bottom: 2px solid #eee; }
        .tab-item {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-item:hover { color: #1a73e8; }
        .tab-item.active { color: #1a73e8; border-bottom-color: #1a73e8; font-weight: 600; }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container { padding: 12px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            .config-form { flex-direction: column; }
            .page-header { flex-direction: column; gap: 10px; }
        }

        /* Tooltip */
        .text-muted { color: #999; font-size: 12px; }
        .text-ellipsis {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
        }

        /* Animation */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter, .fade-leave-to { opacity: 0; }

        /* Pulse dot for running indicator */
        .pulse-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34a853;
            margin-right: 6px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Progress bar */
        .pool-progress {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        .pool-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .progress-safe { background: linear-gradient(90deg, #34a853, #5ec879); }
        .progress-warn { background: linear-gradient(90deg, #f9a825, #fbc02d); }
        .progress-danger { background: linear-gradient(90deg, #ea4335, #f06292); }

        /* Thread state badges */
        .badge-state {
            display: inline-block;
            padding: 1px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .state-runnable { background: #e8f5e9; color: #2e7d32; }
        .state-waiting, .state-timed_waiting { background: #fff3e0; color: #e65100; }
        .state-blocked { background: #fce4ec; color: #c62828; }
        .state-new { background: #e3f2fd; color: #1565c0; }
        .state-terminated { background: #f5f5f5; color: #757575; }
        .state-delaying { background: #e8eaf6; color: #283593; animation: delayPulse 2s infinite; }
        @keyframes delayPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .badge-interrupted { background: #fff3e0; color: #e65100; }
        .badge-lock { background: #fce4ec; color: #c62828; font-size: 10px; padding: 1px 6px; border-radius: 6px; margin-left: 4px; font-weight: 500; }
        .row-delaying { background: #f3f4ff !important; }
        .row-delaying:hover { background: #e8eaff !important; }

        /* Timeout row highlight */
        .row-timeout { background: #fff8e1 !important; }
        .row-timeout:hover { background: #fff3cd !important; }
        .timeout-icon { color: #e65100; margin-right: 4px; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Action buttons in table */
        .btn-action {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-interrupt {
            color: #ea4335;
            border-color: #ea4335;
            background: transparent;
        }
        .btn-interrupt:hover { background: #ea4335; color: #fff; }
        .btn-stack {
            color: #1a73e8;
            border-color: #1a73e8;
            background: transparent;
        }
        .btn-stack:hover { background: #1a73e8; color: #fff; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-box {
            background: #fff;
            border-radius: 10px;
            width: 700px;
            max-width: 90vw;
            max-height: 80vh;
            display: flex; flex-direction: column;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { font-size: 16px; margin: 0; }
        .modal-close {
            background: none; border: none; font-size: 20px;
            cursor: pointer; color: #999; padding: 4px 8px;
        }
        .modal-close:hover { color: #333; }
        .modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }
        .stack-trace {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
        .task-info-row { display: flex; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; }
        .task-info-item { font-size: 13px; }
        .task-info-item label { color: #888; margin-right: 4px; }
        .task-info-item span { color: #333; font-weight: 500; }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1><i class="fa fa-server"></i>线程池管理系统</h1>
            <div class="header-info" v-if="pool.startTime">
                启动时间: {{pool.startTime}} &nbsp;|&nbsp; 运行时长: {{pool.uptime}}
            </div>
        </div>
        <div class="header-actions">
            <div class="toggle-switch">
                <span>自动刷新</span>
                <input type="checkbox" id="autoRefresh" class="switch-input" v-model="autoRefresh" @change="toggleAutoRefresh">
                <label for="autoRefresh" class="switch-label"></label>
                <select v-model="refreshInterval" @change="toggleAutoRefresh" style="border:1px solid rgba(255,255,255,0.3);background:transparent;color:#fff;border-radius:4px;padding:3px 6px;font-size:12px;">
                    <option value="3000" style="color:#333;">3秒</option>
                    <option value="5000" style="color:#333;">5秒</option>
                    <option value="10000" style="color:#333;">10秒</option>
                    <option value="30000" style="color:#333;">30秒</option>
                </select>
            </div>
            <button class="btn btn-sm btn-outline-light" @click="loadAll" style="font-size:13px;">
                <i class="fa fa-refresh"></i> 立即刷新
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- Stats Cards -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fa fa-cogs"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.activeCount || 0}}</div>
                    <div class="stat-label">活跃线程数</div>
                    <div class="pool-progress">
                        <div class="pool-progress-bar" :class="poolUsageClass" :style="{width: poolUsagePercent + '%'}"></div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fa fa-cubes"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.poolSize || 0}}</div>
                    <div class="stat-label">当前池大小</div>
                    <div class="text-muted">核心:{{pool.corePoolSize || 0}} / 最大:{{pool.maxPoolSize || 0}}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange"><i class="fa fa-list-ol"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.queueSize || 0}}</div>
                    <div class="stat-label">队列中等待</div>
                    <div class="text-muted">运行中:{{pool.runningCount || 0}}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon teal"><i class="fa fa-paper-plane"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.totalSubmitted || 0}}</div>
                    <div class="stat-label">累计提交任务</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fa fa-check-circle"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.totalCompleted || 0}}</div>
                    <div class="stat-label">已完成</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red"><i class="fa fa-times-circle"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.totalFailed || 0}}</div>
                    <div class="stat-label">失败次数</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple"><i class="fa fa-hand-stop-o"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.totalInterrupted || 0}}</div>
                    <div class="stat-label">中断次数</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple"><i class="fa fa-ban"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.totalRejected || 0}}</div>
                    <div class="stat-label">拒绝次数</div>
                </div>
            </div>
            <div class="stat-card" :style="(pool.totalSkipped || 0) > 0 ? {borderLeft: '3px solid #78909c'} : {}">
                <div class="stat-icon teal"><i class="fa fa-forward"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{pool.totalSkipped || 0}}</div>
                    <div class="stat-label">跳过次数</div>
                    <div class="text-muted" title="未获取锁/Redis不可用/系统未就绪等">含锁竞争跳过</div>
                </div>
            </div>
            <div class="stat-card" :style="(pool.timeoutCount || 0) > 0 ? {borderLeft: '3px solid #e65100'} : {}">
                <div class="stat-icon orange"><i class="fa fa-exclamation-triangle"></i></div>
                <div class="stat-info">
                    <div class="stat-value" :style="(pool.timeoutCount || 0) > 0 ? {color:'#e65100'} : {}">{{pool.timeoutCount || 0}}</div>
                    <div class="stat-label">超时预警</div>
                </div>
            </div>
            <div class="stat-card" :style="(pool.delayingCount || 0) > 0 ? {borderLeft: '3px solid #283593'} : {}">
                <div class="stat-icon purple"><i class="fa fa-hourglass-half"></i></div>
                <div class="stat-info">
                    <div class="stat-value" :style="(pool.delayingCount || 0) > 0 ? {color:'#283593'} : {}">{{pool.delayingCount || 0}}</div>
                    <div class="stat-label">延迟等待中</div>
                    <div class="text-muted" v-if="pool.globalStaggerSeconds > 0">全局错峰: {{pool.globalStaggerSeconds}}s</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fa fa-clock-o"></i></div>
                <div class="stat-info">
                    <div class="stat-value">{{formatMs(pool.avgExecutionTime || 0)}}</div>
                    <div class="stat-label">平均执行耗时</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-row">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title"><i class="fa fa-pie-chart"></i>线程池容量分布</span>
                </div>
                <div class="panel-body">
                    <div id="chartCapacity" class="chart-container"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title"><i class="fa fa-bar-chart"></i>任务执行统计</span>
                </div>
                <div class="panel-body">
                    <div id="chartStats" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="panel">
            <div class="tab-bar">
                <div class="tab-item" :class="{active: activeTab === 'running'}" @click="activeTab='running'">
                    <i class="fa fa-play-circle"></i> 运行中任务
                    <span class="badge-status badge-running" style="margin-left:4px;" v-if="runningList.length > 0">{{runningList.length}}</span>
                </div>
                <div class="tab-item" :class="{active: activeTab === 'history'}" @click="switchToHistory">
                    <i class="fa fa-history"></i> 执行历史
                </div>
                <div class="tab-item" :class="{active: activeTab === 'config'}" @click="activeTab='config'">
                    <i class="fa fa-sliders"></i> 线程池配置
                </div>
            </div>

            <!-- Running Tasks Tab -->
            <div v-show="activeTab === 'running'">
                <div class="panel-body" style="border-bottom:1px solid #f0f0f0;" v-if="runningList.length > 0">
                    <div class="filter-bar">
                        <input type="text" v-model="runningKeyword" placeholder="搜索任务名称/标记/来源/方法..." style="width:240px;">
                        <select v-model="runningFilter" style="min-width:120px;">
                            <option value="">全部任务</option>
                            <option value="delaying">延迟等待中</option>
                            <option value="timeout">已超时</option>
                            <option value="hasDelay">配置了延迟</option>
                            <option value="hasTimeout">配置了超时</option>
                            <option value="locked">使用分布式锁</option>
                        </select>
                        <span style="font-size:12px;color:#888;" v-if="filteredRunningList.length !== runningList.length">显示 {{filteredRunningList.length}} / {{runningList.length}}</span>
                    </div>
                </div>
                <div class="panel-body no-padding">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width:40px;">#</th>
                                <th>任务名称</th>
                                <th>任务标记</th>
                                <th>调用来源</th>
                                <th>调用方法</th>
                                <th>执行线程</th>
                                <th>线程状态</th>
                                <th>启动时间</th>
                                <th>已运行</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in filteredRunningList" :key="index" :class="{'row-timeout': item.isTimeout, 'row-delaying': item.isDelaying}">
                                <td>{{index + 1}}</td>
                                <td>
                                    <i class="fa fa-hourglass-half" style="color:#283593;margin-right:4px;" v-if="item.isDelaying" title="错峰延迟等待中"></i>
                                    <i class="fa fa-exclamation-triangle timeout-icon" v-if="item.isTimeout" title="任务已超时！"></i>
                                    <span class="text-ellipsis" :title="item.name">{{item.name || '-'}}</span>
                                    <span class="badge-lock" v-if="item.isLocked" title="使用分布式锁"><i class="fa fa-lock" style="margin-right:2px;"></i>锁</span>
                                    <div style="margin-top:3px;display:flex;gap:4px;flex-wrap:wrap;" v-if="item.timeout > 0 || item.delay > 0 || (item.isLocked && item.lockLeaseTime > 0)">
                                        <span v-if="item.timeout > 0" class="badge-state" :style="{background: item.isTimeout ? '#fff3e0' : '#e3f2fd', color: item.isTimeout ? '#e65100' : '#1565c0', fontSize:'10px'}" :title="'超时阈值: ' + item.timeout + '秒'"><i class="fa fa-clock-o" style="margin-right:2px;"></i>超时{{item.timeout}}s</span>
                                        <span v-if="item.delay > 0" class="badge-state" style="background:#e8eaf6;color:#283593;font-size:10px;" :title="'错峰延迟窗口: 0~' + item.delay + '秒'"><i class="fa fa-hourglass-half" style="margin-right:2px;"></i>延迟{{item.delay}}s</span>
                                        <span v-if="item.isLocked && item.lockLeaseTime > 0" class="badge-state" style="background:#fce4ec;color:#c62828;font-size:10px;" :title="'锁租约: ' + item.lockLeaseTime + '秒内只执行一次'"><i class="fa fa-lock" style="margin-right:2px;"></i>锁{{item.lockLeaseTime}}s</span>
                                    </div>
                                </td>
                                <td>{{item.tag || '-'}}</td>
                                <td>{{item.type || '-'}}</td>
                                <td>{{item.method || '-'}}</td>
                                <td><span class="text-muted">{{item.threadName || '-'}}</span></td>
                                <td>
                                    <span class="badge-state" :class="getStateClass(item.threadState)">
                                        {{translateState(item.threadState)}}
                                    </span>
                                </td>
                                <td>{{item.time || '-'}}</td>
                                <td>
                                    <span style="color:#1a73e8;font-weight:500;">{{item.runningTime || '-'}}</span>
                                    <span v-if="item.isTimeout" style="color:#e65100;font-size:11px;margin-left:4px;">(超过{{item.timeout}}s)</span>
                                    <div v-if="item.delay > 0" style="margin-top:2px;font-size:11px;">
                                        <span v-if="item.isDelaying" style="color:#283593;"><i class="fa fa-hourglass-half" style="margin-right:2px;"></i>延迟等待中 ({{item.delay}}s窗口)</span>
                                        <span v-else style="color:#888;">延迟{{item.delay}}s 已过</span>
                                    </div>
                                </td>
                                <td style="white-space:nowrap;">
                                    <button class="btn-action btn-stack" @click="showStackTrace(item.index)" title="查看线程堆栈">
                                        <i class="fa fa-code"></i> 堆栈
                                    </button>
                                    <button class="btn-action btn-interrupt" @click="interruptTask(item.index, item.tag)" title="中断此任务" style="margin-left:4px;">
                                        <i class="fa fa-stop"></i> 中断
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="filteredRunningList.length === 0">
                                <td colspan="10" class="no-data">
                                    <i class="fa fa-inbox" style="font-size:30px;color:#ddd;display:block;margin-bottom:8px;"></i>
                                    {{runningList.length === 0 ? '当前没有运行中的任务' : '没有匹配的任务'}}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Stack Trace Modal -->
            <div class="modal-overlay" v-if="showModal" @click.self="showModal=false">
                <div class="modal-box">
                    <div class="modal-header">
                        <h3><i class="fa fa-code" style="color:#1a73e8;margin-right:8px;"></i>线程堆栈诊断</h3>
                        <button class="modal-close" @click="showModal=false">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="task-info-row" v-if="modalTask">
                            <div class="task-info-item"><label>任务:</label><span>{{modalTask.tag || modalTask.name || '-'}}</span></div>
                            <div class="task-info-item"><label>来源:</label><span>{{modalTask.type || '-'}}</span></div>
                            <div class="task-info-item"><label>方法:</label><span>{{modalTask.method || '-'}}</span></div>
                            <div class="task-info-item"><label>线程:</label><span>{{modalTask.threadName || '-'}}</span></div>
                            <div class="task-info-item"><label>状态:</label>
                                <span class="badge-state" :class="getStateClass(modalTask.threadState)">{{translateState(modalTask.threadState)}}</span>
                            </div>
                            <div class="task-info-item"><label>已运行:</label><span>{{modalTask.runningTime || '-'}}</span></div>
                            <div class="task-info-item" v-if="modalTask.isLocked"><label>分布式锁:</label><span style="color:#c62828;"><i class="fa fa-lock"></i> 已启用<span v-if="modalTask.lockLeaseTime > 0">（租约{{modalTask.lockLeaseTime}}秒）</span></span></div>
                            <div class="task-info-item" v-if="modalTask.timeout > 0"><label>超时阈值:</label><span :style="{color: modalTask.isTimeout ? '#e65100' : '#1565c0', fontWeight: modalTask.isTimeout ? '600' : '500'}">{{modalTask.timeout}}秒<span v-if="modalTask.isTimeout" style="color:#e65100;margin-left:4px;">（已超时！）</span></span></div>
                            <div class="task-info-item" v-if="modalTask.delay > 0"><label>延迟窗口:</label><span style="color:#283593;">0~{{modalTask.delay}}秒<span v-if="modalTask.isDelaying" style="margin-left:4px;">（等待中）</span></span></div>
                        </div>
                        <div class="stack-trace" v-if="modalStack">{{modalStack}}</div>
                        <div v-else style="text-align:center;padding:30px;color:#aaa;">
                            <i class="fa fa-spinner fa-spin" v-if="modalLoading"></i>
                            <span v-else>暂无堆栈信息（任务可能已结束）</span>
                        </div>
                        <div style="margin-top:12px;text-align:right;">
                            <button class="btn-outline" @click="refreshStackTrace" style="margin-right:8px;">
                                <i class="fa fa-refresh"></i> 刷新堆栈
                            </button>
                            <button class="btn-action btn-interrupt" @click="interruptTask(modalTaskIndex, modalTask ? modalTask.tag : ''); showModal=false;">
                                <i class="fa fa-stop"></i> 中断此任务
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div v-show="activeTab === 'history'">
                <div class="panel-body" style="border-bottom:1px solid #f0f0f0;">
                    <div class="filter-bar">
                        <input type="text" v-model="historyKeyword" placeholder="搜索任务名称/标记/方法..." style="width:240px;" @keyup.enter="loadHistory">
                        <select v-model="historyStatus" @change="loadHistory">
                            <option value="">全部状态</option>
                            <option value="COMPLETED">已完成</option>
                            <option value="FAILED">失败</option>
                            <option value="INTERRUPTED">已中断</option>
                            <option value="SKIPPED">已跳过</option>
                        </select>
                        <button class="btn-outline btn-sm" @click="loadHistory"><i class="fa fa-search"></i> 搜索</button>
                        <button class="btn-danger-outline btn-sm" @click="clearHistory"><i class="fa fa-trash-o"></i> 清除历史</button>
                    </div>
                </div>
                <div class="panel-body no-padding">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width:40px;">#</th>
                                <th>任务名称</th>
                                <th>任务标记</th>
                                <th>调用来源</th>
                                <th>调用方法</th>
                                <th>开始时间</th>
                                <th>结束时间</th>
                                <th>耗时</th>
                                <th>状态</th>
                                <th>错误信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(item, index) in historyList" :key="index">
                                <td>{{historyPage * historySize + index + 1}}</td>
                                <td>
                                    <span class="text-ellipsis" :title="item.name">{{item.name || '-'}}</span>
                                    <div style="margin-top:2px;display:flex;gap:3px;flex-wrap:wrap;" v-if="item.timeout > 0 || item.delay > 0 || item.locked">
                                        <span v-if="item.timeout > 0" class="badge-state" style="background:#e3f2fd;color:#1565c0;font-size:10px;" :title="'超时阈值: ' + item.timeout + '秒'">超时{{item.timeout}}s</span>
                                        <span v-if="item.delay > 0" class="badge-state" style="background:#e8eaf6;color:#283593;font-size:10px;" :title="'延迟窗口: ' + item.delay + '秒'">延迟{{item.delay}}s</span>
                                        <span v-if="item.locked" class="badge-state" style="background:#fce4ec;color:#c62828;font-size:10px;">锁</span>
                                    </div>
                                </td>
                                <td>{{item.tag || '-'}}</td>
                                <td>{{item.typeName || '-'}}</td>
                                <td>{{item.method || '-'}}</td>
                                <td>{{item.startTimeStr || '-'}}</td>
                                <td>{{item.endTimeStr || '-'}}</td>
                                <td><span style="font-weight:500;">{{item.durationStr || '-'}}</span></td>
                                <td>
                                    <span class="badge-status" :class="getHistoryStatusClass(item.status)">
                                        {{translateStatus(item.status)}}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-ellipsis" :title="item.errorMessage" style="max-width:150px;color:#ea4335;" v-if="item.errorMessage">
                                        {{item.errorMessage}}
                                    </span>
                                    <span v-else>-</span>
                                </td>
                            </tr>
                            <tr v-if="historyList.length === 0">
                                <td colspan="10" class="no-data">
                                    <i class="fa fa-inbox" style="font-size:30px;color:#ddd;display:block;margin-bottom:8px;"></i>
                                    暂无历史记录
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination-bar" v-if="historyTotal > 0">
                    <span>共 {{historyTotal}} 条记录，第 {{historyPage + 1}} / {{historyPages}} 页</span>
                    <div class="pagination-btns">
                        <button @click="historyPage=0;loadHistory()" :disabled="historyPage === 0">首页</button>
                        <button @click="historyPage--;loadHistory()" :disabled="historyPage === 0">上一页</button>
                        <button @click="historyPage++;loadHistory()" :disabled="historyPage >= historyPages - 1">下一页</button>
                        <button @click="historyPage=historyPages-1;loadHistory()" :disabled="historyPage >= historyPages - 1">末页</button>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div v-show="activeTab === 'config'">
                <div class="panel-body">
                    <!-- ====== 动态参数调整表单 ====== -->
                    <h4 style="margin-bottom:16px;color:#333;font-size:15px;">
                        <i class="fa fa-wrench" style="color:#1a73e8;margin-right:6px;"></i>动态调整线程池参数
                    </h4>
                    <div class="config-form">
                        <div class="config-group">
                            <label>核心线程数（当前: {{pool.corePoolSize}}）</label>
                            <input type="number" v-model.number="configForm.corePoolSize" min="1" max="100000" placeholder="输入核心线程数">
                        </div>
                        <div class="config-group">
                            <label>最大线程数（当前: {{pool.maxPoolSize}}）</label>
                            <input type="number" v-model.number="configForm.maxPoolSize" min="1" max="100000" placeholder="输入最大线程数">
                        </div>
                        <div class="config-group">
                            <label>保活时间（当前: {{pool.keepAliveSeconds}}秒）</label>
                            <input type="number" v-model.number="configForm.keepAliveSeconds" min="1" max="3600" placeholder="1~3600秒">
                        </div>
                        <div class="config-group">
                            <label>核心线程超时回收</label>
                            <div style="display:flex;align-items:center;height:34px;gap:8px;">
                                <span style="font-size:12px;color:#888;">当前: <b :style="{color: pool.allowCoreThreadTimeOut ? '#2e7d32' : '#e65100'}">{{pool.allowCoreThreadTimeOut ? '开启' : '关闭'}}</b></span>
                                <select v-model="configForm.allowCoreThreadTimeOut" style="border:1px solid #ddd;border-radius:6px;padding:5px 10px;font-size:13px;outline:none;width:100px;">
                                    <option value="">不修改</option>
                                    <option value="true">开启</option>
                                    <option value="false">关闭</option>
                                </select>
                            </div>
                        </div>
                        <div class="config-group">
                            <label>全局错峰延迟（当前: {{pool.globalStaggerSeconds || 0}}秒）</label>
                            <input type="number" v-model.number="configForm.staggerSeconds" min="0" max="3600" placeholder="0=不延迟">
                        </div>
                        <div class="config-group">
                            <label>最大历史记录数（当前: {{pool.maxHistorySize || 500}}）</label>
                            <input type="number" v-model.number="configForm.maxHistorySize" min="10" max="100000" placeholder="10~100000">
                        </div>
                    </div>
                    <div style="margin-top:12px;display:flex;gap:8px;">
                        <button class="btn-primary-custom" @click="updateConfig">
                            <i class="fa fa-save"></i> 应用配置
                        </button>
                        <button class="btn-danger-outline" @click="resetStats">
                            <i class="fa fa-refresh"></i> 重置统计
                        </button>
                    </div>
                    <div style="margin-top:16px;padding:12px;background:#e8eaf6;border-radius:6px;border-left:3px solid #283593;font-size:13px;color:#333;">
                        <i class="fa fa-info-circle" style="color:#283593;margin-right:6px;"></i>
                        <b>参数说明：</b>
                        <b>核心线程数</b>=常驻工作线程；<b>最大线程数</b>=队列满后弹性扩容上限；
                        <b>保活时间</b>=非核心线程空闲后回收等待秒数；<b>核心线程超时</b>=开启后核心线程空闲也会被回收。
                        <b>错峰延迟</b>=任务执行前随机延迟 [0, N) 秒，单任务可通过 <code>@TagValue(delay=30)</code> 独立配置。
                    </div>

                    <!-- ====== 系统资源信息 ====== -->
                    <div style="margin-top:20px;padding:16px;background:#e8f5e9;border-radius:6px;border-left:3px solid #2e7d32;">
                        <h5 style="margin-bottom:8px;font-size:14px;color:#333;"><i class="fa fa-microchip" style="color:#2e7d32;margin-right:6px;"></i>系统资源</h5>
                        <table style="font-size:13px;color:#555;">
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">CPU 核数</td><td>{{pool.cpuCores}} 核</td></tr>
                            <tr>
                                <td style="padding:4px 20px 4px 0;font-weight:500;">JVM 堆内存</td>
                                <td>
                                    已用 {{pool.heapUsedMB || 0}} MB / 已分配 {{pool.heapTotalMB || 0}} MB / 最大 {{pool.heapMaxMB || 0}} MB
                                    <div class="pool-progress" style="width:200px;margin-top:4px;">
                                        <div class="pool-progress-bar" :class="heapUsageClass" :style="{width: heapUsagePercent + '%'}"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:4px 20px 4px 0;font-weight:500;">建议线程数</td>
                                <td>
                                    核心: {{pool.cpuCores * 2}} (CPU×2) &nbsp;|&nbsp;
                                    上限: {{Math.min(Math.floor((pool.heapMaxMB || 512) * 0.15), 500)}} (堆×15%/1MB)
                                    <span style="color:#888;margin-left:8px;font-size:12px;">— 基于当前系统资源自动计算参考值</span>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- ====== 线程池配置详情 ====== -->
                    <div style="margin-top:20px;padding:16px;background:#f8f9fa;border-radius:6px;border-left:3px solid #1a73e8;">
                        <h5 style="margin-bottom:8px;font-size:14px;color:#333;"><i class="fa fa-cog" style="color:#1a73e8;margin-right:6px;"></i>线程池配置详情</h5>
                        <table style="font-size:13px;color:#555;">
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">核心线程数</td><td>{{pool.corePoolSize}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">最大线程数</td><td>{{pool.maxPoolSize}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">当前池大小</td><td>{{pool.poolSize}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">活跃线程数</td><td>{{pool.activeCount}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">最大记录池大小</td><td>{{pool.largestPoolSize}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">队列使用 / 容量</td><td>{{pool.queueSize}} / {{pool.queueCapacity}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">保活时间</td><td>{{pool.keepAliveSeconds}} 秒</td></tr>
                            <tr>
                                <td style="padding:4px 20px 4px 0;font-weight:500;">核心线程超时回收</td>
                                <td>
                                    <span v-if="pool.allowCoreThreadTimeOut" style="color:#2e7d32;font-weight:500;">开启</span>
                                    <span v-else style="color:#e65100;font-weight:500;">关闭</span>
                                    <span style="color:#999;margin-left:8px;font-size:12px;">（开启 = 空闲核心线程也会被回收，节省资源）</span>
                                </td>
                            </tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">全局错峰延迟</td><td>{{pool.globalStaggerSeconds || 0}}秒<span v-if="pool.globalStaggerSeconds > 0" style="color:#283593;margin-left:8px;">（已启用）</span><span v-else style="color:#999;margin-left:8px;">（未启用）</span></td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">延迟等待中</td><td>{{pool.delayingCount || 0}} 个任务</td></tr>
                        </table>
                    </div>

                    <!-- ====== 统计与监控信息 ====== -->
                    <div style="margin-top:20px;padding:16px;background:#f8f9fa;border-radius:6px;border-left:3px solid #7b1fa2;">
                        <h5 style="margin-bottom:8px;font-size:14px;color:#333;"><i class="fa fa-bar-chart" style="color:#7b1fa2;margin-right:6px;"></i>统计与监控</h5>
                        <table style="font-size:13px;color:#555;">
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">累计任务数（JVM）</td><td>{{pool.taskCount}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">已完成任务数（JVM）</td><td>{{pool.completedTaskCount}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">最大历史记录数</td><td>{{pool.maxHistorySize || 500}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">当前历史记录数</td><td>{{pool.historyCount || 0}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">ID 缓存数</td><td>{{pool.idsCount || 0}}</td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">累计清理死条目</td><td>{{pool.totalSweptCount || 0}} 个<span v-if="pool.lastSweepRemovedCount > 0" style="color:#e65100;margin-left:8px;">（上轮清理: {{pool.lastSweepRemovedCount}}）</span></td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">累计跳过</td><td>{{pool.totalSkipped || 0}} 个<span style="color:#78909c;margin-left:8px;">（未获取锁/Redis不可用/系统未就绪等）</span></td></tr>
                            <tr><td style="padding:4px 20px 4px 0;font-weight:500;">任务核算</td>
                                <td>
                                    <span>提交: {{pool.totalSubmitted || 0}}</span> =
                                    <span style="color:#2e7d32;">完成: {{pool.totalCompleted || 0}}</span> +
                                    <span style="color:#c62828;">失败: {{pool.totalFailed || 0}}</span> +
                                    <span style="color:#e65100;">中断: {{pool.totalInterrupted || 0}}</span> +
                                    <span style="color:#7b1fa2;">拒绝: {{pool.totalRejected || 0}}</span> +
                                    <span style="color:#78909c;">跳过: {{pool.totalSkipped || 0}}</span> +
                                    <span style="color:#1a73e8;">运行中: {{pool.runningCount || 0}}</span>
                                    <span v-if="(pool.totalSubmitted || 0) === (pool.totalCompleted || 0) + (pool.totalFailed || 0) + (pool.totalInterrupted || 0) + (pool.totalRejected || 0) + (pool.totalSkipped || 0) + (pool.runningCount || 0)" style="color:#2e7d32;margin-left:8px;font-weight:500;"><i class="fa fa-check-circle"></i> 平衡</span>
                                    <span v-else style="color:#c62828;margin-left:8px;font-weight:500;"><i class="fa fa-exclamation-circle"></i> 不平衡</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="${request.contextPath}/statics/libs/jquery.min.js"></script>
<script src="${request.contextPath}/statics/libs/vue.min.js"></script>
<script src="${request.contextPath}/statics/js/echarts.min.js"></script>
<script>
var basePath = '${request.contextPath}/sys/thread/';
var vm = new Vue({
    el: '#app',
    data: {
        activeTab: 'running',
        autoRefresh: true,
        refreshInterval: 5000,
        refreshTimer: null,

        // Pool info
        pool: {},

        // Running tasks
        runningList: [],
        runningKeyword: '',
        runningFilter: '',

        // History
        historyList: [],
        historyPage: 0,
        historySize: 20,
        historyTotal: 0,
        historyPages: 0,
        historyKeyword: '',
        historyStatus: '',

        // Config form
        configForm: {
            corePoolSize: null,
            maxPoolSize: null,
            keepAliveSeconds: null,
            allowCoreThreadTimeOut: '',
            staggerSeconds: null,
            maxHistorySize: null
        },

        // Charts
        capacityChart: null,
        statsChart: null,

        // Stack trace modal
        showModal: false,
        modalTask: null,
        modalTaskIndex: -1,
        modalStack: '',
        modalLoading: false
    },
    computed: {
        filteredRunningList: function() {
            var self = this;
            var list = this.runningList;
            // 关键字搜索
            if (self.runningKeyword) {
                var kw = self.runningKeyword.toLowerCase();
                list = list.filter(function(item) {
                    return (item.name || '').toLowerCase().indexOf(kw) >= 0
                        || (item.tag || '').toLowerCase().indexOf(kw) >= 0
                        || (item.type || '').toLowerCase().indexOf(kw) >= 0
                        || (item.method || '').toLowerCase().indexOf(kw) >= 0
                        || (item.threadName || '').toLowerCase().indexOf(kw) >= 0;
                });
            }
            // 条件筛选
            var f = self.runningFilter;
            if (f === 'delaying') list = list.filter(function(i) { return i.isDelaying; });
            else if (f === 'timeout') list = list.filter(function(i) { return i.isTimeout; });
            else if (f === 'hasDelay') list = list.filter(function(i) { return i.delay > 0; });
            else if (f === 'hasTimeout') list = list.filter(function(i) { return i.timeout > 0; });
            else if (f === 'locked') list = list.filter(function(i) { return i.isLocked; });
            return list;
        },
        poolUsagePercent: function() {
            if (!this.pool.maxPoolSize || this.pool.maxPoolSize === 0) return 0;
            return Math.min(100, Math.round((this.pool.activeCount || 0) / this.pool.maxPoolSize * 100));
        },
        poolUsageClass: function() {
            var pct = this.poolUsagePercent;
            if (pct < 50) return 'progress-safe';
            if (pct < 80) return 'progress-warn';
            return 'progress-danger';
        },
        heapUsagePercent: function() {
            if (!this.pool.heapMaxMB || this.pool.heapMaxMB === 0) return 0;
            return Math.min(100, Math.round((this.pool.heapUsedMB || 0) / this.pool.heapMaxMB * 100));
        },
        heapUsageClass: function() {
            var pct = this.heapUsagePercent;
            if (pct < 60) return 'progress-safe';
            if (pct < 85) return 'progress-warn';
            return 'progress-danger';
        }
    },
    mounted: function() {
        this.loadAll();
        this.startAutoRefresh();
    },
    beforeDestroy: function() {
        this.stopAutoRefresh();
    },
    methods: {
        loadAll: function() {
            this.loadInfo();
            if (this.activeTab === 'history') {
                this.loadHistory();
            }
        },
        loadInfo: function() {
            var self = this;
            $.ajax({
                type: 'POST',
                url: basePath + 'info',
                dataType: 'json',
                success: function(res) {
                    if (res.code === 0) {
                        self.pool = res.pool || {};
                        self.runningList = res.running || [];
                        self.updateCharts();
                    }
                },
                error: function() {
                    console.error('加载线程池信息失败');
                }
            });
        },
        loadHistory: function() {
            var self = this;
            $.ajax({
                type: 'POST',
                url: basePath + 'history',
                data: {
                    page: self.historyPage,
                    size: self.historySize,
                    status: self.historyStatus,
                    keyword: self.historyKeyword
                },
                dataType: 'json',
                success: function(res) {
                    if (res.code === 0) {
                        self.historyList = res.list || [];
                        self.historyTotal = res.total || 0;
                        self.historyPages = res.pages || 0;
                    }
                }
            });
        },
        switchToHistory: function() {
            this.activeTab = 'history';
            this.loadHistory();
        },
        clearHistory: function() {
            if (!confirm('确认要清除所有历史记录吗？')) return;
            var self = this;
            $.ajax({
                type: 'POST',
                url: basePath + 'clearHistory',
                dataType: 'json',
                success: function(res) {
                    if (res.code === 0) {
                        self.historyList = [];
                        self.historyTotal = 0;
                        self.historyPages = 0;
                        self.historyPage = 0;
                        alert('历史记录已清除');
                    }
                }
            });
        },
        updateConfig: function() {
            var self = this;
            var data = {};
            var hasConfig = false;
            if (self.configForm.corePoolSize) { data.corePoolSize = self.configForm.corePoolSize; hasConfig = true; }
            if (self.configForm.maxPoolSize) { data.maxPoolSize = self.configForm.maxPoolSize; hasConfig = true; }
            if (self.configForm.keepAliveSeconds) { data.keepAliveSeconds = self.configForm.keepAliveSeconds; hasConfig = true; }
            if (self.configForm.allowCoreThreadTimeOut !== '') { data.allowCoreThreadTimeOut = self.configForm.allowCoreThreadTimeOut; hasConfig = true; }
            if (self.configForm.staggerSeconds !== null && self.configForm.staggerSeconds !== '') {
                data.staggerSeconds = self.configForm.staggerSeconds; hasConfig = true;
            }
            if (self.configForm.maxHistorySize) { data.maxHistorySize = self.configForm.maxHistorySize; hasConfig = true; }

            if (!hasConfig) {
                alert('请至少填写一项配置');
                return;
            }

            if (data.corePoolSize && data.maxPoolSize && data.corePoolSize > data.maxPoolSize) {
                alert('核心线程数不能大于最大线程数');
                return;
            }

            $.ajax({
                type: 'POST',
                url: basePath + 'config',
                data: data,
                dataType: 'json',
                success: function(res) {
                    if (res.code === 0) {
                        self.pool = res.pool || self.pool;
                        self.configForm.corePoolSize = null;
                        self.configForm.maxPoolSize = null;
                        self.configForm.keepAliveSeconds = null;
                        self.configForm.allowCoreThreadTimeOut = '';
                        self.configForm.staggerSeconds = null;
                        self.configForm.maxHistorySize = null;
                        alert('配置更新成功');
                        self.updateCharts();
                    } else {
                        alert(res.msg || '配置更新失败');
                    }
                }
            });
        },
        resetStats: function() {
            if (!confirm('确认要重置所有统计数据吗？')) return;
            var self = this;
            $.ajax({
                type: 'POST',
                url: basePath + 'resetStats',
                dataType: 'json',
                success: function(res) {
                    if (res.code === 0) {
                        self.pool = res.pool || self.pool;
                        self.updateCharts();
                        alert('统计数据已重置');
                    }
                }
            });
        },
        toggleAutoRefresh: function() {
            this.stopAutoRefresh();
            if (this.autoRefresh) {
                this.startAutoRefresh();
            }
        },
        startAutoRefresh: function() {
            if (!this.autoRefresh) return;
            var self = this;
            this.refreshTimer = setInterval(function() {
                self.loadAll();
            }, self.refreshInterval);
        },
        stopAutoRefresh: function() {
            if (this.refreshTimer) {
                clearInterval(this.refreshTimer);
                this.refreshTimer = null;
            }
        },
        formatMs: function(ms) {
            if (!ms || ms === 0) return '0ms';
            if (ms < 1000) return ms + 'ms';
            if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
            return Math.floor(ms / 60000) + 'm' + Math.floor((ms % 60000) / 1000) + 's';
        },
        updateCharts: function() {
            this.updateCapacityChart();
            this.updateStatsChart();
        },
        updateCapacityChart: function() {
            if (!document.getElementById('chartCapacity')) return;
            if (!this.capacityChart) {
                this.capacityChart = echarts.init(document.getElementById('chartCapacity'));
            }
            var pool = this.pool;
            var active = pool.activeCount || 0;
            var idle = Math.max(0, (pool.poolSize || 0) - active);
            var queued = pool.queueSize || 0;
            var available = Math.max(0, (pool.maxPoolSize || 0) - (pool.poolSize || 0));

            this.capacityChart.setOption({
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: {
                    orient: 'vertical',
                    right: '5%',
                    top: 'center',
                    textStyle: { fontSize: 12, color: '#666' }
                },
                color: ['#1a73e8', '#34a853', '#f9a825', '#e0e0e0'],
                series: [{
                    type: 'pie',
                    radius: ['42%', '70%'],
                    center: ['35%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 2 },
                    label: { show: false },
                    emphasis: {
                        label: { show: true, fontSize: 14, fontWeight: 'bold' }
                    },
                    data: [
                        { value: active, name: '活跃线程' },
                        { value: idle, name: '空闲线程' },
                        { value: queued, name: '队列等待' },
                        { value: available, name: '可用容量' }
                    ]
                }]
            });
        },
        updateStatsChart: function() {
            if (!document.getElementById('chartStats')) return;
            if (!this.statsChart) {
                this.statsChart = echarts.init(document.getElementById('chartStats'));
            }
            var pool = this.pool;

            this.statsChart.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: ['提交', '完成', '失败', '中断', '拒绝', '跳过', '运行中'],
                    axisLabel: { fontSize: 12, color: '#666' },
                    axisLine: { lineStyle: { color: '#ddd' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { fontSize: 12, color: '#666' },
                    splitLine: { lineStyle: { color: '#f0f0f0' } }
                },
                series: [{
                    type: 'bar',
                    barWidth: '45%',
                    itemStyle: {
                        borderRadius: [4, 4, 0, 0],
                        color: function(params) {
                            var colors = ['#1a73e8', '#34a853', '#ea4335', '#e65100', '#7b1fa2', '#78909c', '#f9a825'];
                            return colors[params.dataIndex];
                        }
                    },
                    data: [
                        pool.totalSubmitted || 0,
                        pool.totalCompleted || 0,
                        pool.totalFailed || 0,
                        pool.totalInterrupted || 0,
                        pool.totalRejected || 0,
                        pool.totalSkipped || 0,
                        pool.runningCount || 0
                    ]
                }]
            });
        },

        // ======================== 线程管理方法 ========================

        interruptTask: function(index, tag) {
            if (!confirm('确认要中断任务 [' + (tag || '#' + index) + '] 吗？\n\n注意：中断操作会向任务线程发送 interrupt 信号，任务需要支持协作式取消才能正确响应。')) return;
            var self = this;
            $.ajax({
                type: 'POST',
                url: basePath + 'interrupt',
                data: { index: index },
                dataType: 'json',
                success: function(res) {
                    alert(res.msg || '操作完成');
                    self.loadInfo();
                }
            });
        },
        showStackTrace: function(index) {
            this.modalTaskIndex = index;
            this.modalTask = null;
            this.modalStack = '';
            this.showModal = true;
            this.modalLoading = true;

            // 从当前列表获取任务信息
            for (var i = 0; i < this.runningList.length; i++) {
                if (this.runningList[i].index === index) {
                    this.modalTask = this.runningList[i];
                    break;
                }
            }

            this.fetchStackTrace(index);
        },
        fetchStackTrace: function(index) {
            var self = this;
            $.ajax({
                type: 'POST',
                url: basePath + 'stacktrace',
                data: { index: index, depth: 30 },
                dataType: 'json',
                success: function(res) {
                    self.modalLoading = false;
                    if (res.code === 0) {
                        self.modalStack = res.stacktrace || '';
                    }
                },
                error: function() {
                    self.modalLoading = false;
                    self.modalStack = '获取堆栈失败';
                }
            });
        },
        refreshStackTrace: function() {
            this.modalLoading = true;
            this.modalStack = '';
            this.fetchStackTrace(this.modalTaskIndex);
        },
        getStateClass: function(state) {
            if (!state) return 'state-new';
            var s = state.toLowerCase();
            if (s === 'delaying') return 'state-delaying';
            if (s === 'runnable') return 'state-runnable';
            if (s === 'waiting' || s === 'timed_waiting') return 'state-waiting';
            if (s === 'blocked') return 'state-blocked';
            if (s === 'terminated') return 'state-terminated';
            return 'state-new';
        },
        translateState: function(state) {
            var map = {
                'DELAYING': '延迟等待',
                'RUNNABLE': '运行中',
                'WAITING': '等待中',
                'TIMED_WAITING': '限时等待',
                'BLOCKED': '阻塞',
                'NEW': '新建',
                'TERMINATED': '已终止',
                'NOT_STARTED': '未启动',
                'UNKNOWN': '未知'
            };
            return map[state] || state || '未知';
        },
        getHistoryStatusClass: function(status) {
            if (status === 'COMPLETED') return 'badge-completed';
            if (status === 'INTERRUPTED') return 'badge-interrupted';
            if (status === 'SKIPPED') return 'badge-skipped';
            return 'badge-failed';
        },
        translateStatus: function(status) {
            var map = { 'COMPLETED': '成功', 'FAILED': '失败', 'INTERRUPTED': '已中断', 'SKIPPED': '已跳过' };
            return map[status] || status;
        }
    }
});

// Handle window resize for charts
window.addEventListener('resize', function() {
    if (vm.capacityChart) vm.capacityChart.resize();
    if (vm.statsChart) vm.statsChart.resize();
});
</script>
</body>
</html>
