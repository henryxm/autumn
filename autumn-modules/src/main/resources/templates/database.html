<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库备份管理</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background: white;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 32px; font-weight: 600; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        /* Tabs */
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .tab {
            padding: 14px 28px; cursor: pointer; font-size: 14px; font-weight: 500;
            color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: all 0.3s;
        }
        .tab:hover { color: #667eea; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; background: white; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        /* Stats bar */
        .stats-bar {
            background: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #e9ecef;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;
        }
        .stat-item { text-align: center; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-value { font-size: 24px; font-weight: 700; color: #667eea; }
        .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
        /* Running tasks panel */
        .running-panel { background: #eef0ff; padding: 20px 30px; border-bottom: 1px solid #d6daf0; }
        .running-panel h3 { font-size: 16px; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .running-panel h3 .dot { width: 8px; height: 8px; background: #38ef7d; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
        .task-card {
            background: white; border-radius: 8px; padding: 16px; margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06); display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
        }
        .task-info { flex: 1; min-width: 200px; }
        .task-info .task-name { font-weight: 600; font-size: 14px; color: #333; }
        .task-info .task-meta { font-size: 12px; color: #888; margin-top: 4px; }
        .progress-bar-container { flex: 2; min-width: 200px; }
        .progress-bar-outer { background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden; position: relative; }
        .progress-bar-inner {
            height: 100%; border-radius: 10px; transition: width 0.5s ease;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        .progress-bar-inner.paused { background: linear-gradient(90deg, #ffc107, #ff9800); }
        .progress-text { position: absolute; top: 0; left: 0; right: 0; text-align: center; line-height: 20px; font-size: 11px; font-weight: 600; color: white; }
        .task-controls { display: flex; gap: 6px; }
        /* Content */
        .content { padding: 30px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .toolbar h2 { font-size: 20px; color: #333; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px;
            font-weight: 500; cursor: pointer; transition: all 0.3s ease;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); color: white; }
        .btn-danger:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,107,107,0.4); }
        .btn-info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .btn-info:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52,152,219,0.4); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(17,153,142,0.4); }
        .btn-warning { background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%); color: #333; }
        .btn-warning:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(247,151,30,0.4); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 14px; font-size: 12px; }
        .btn-xs { padding: 4px 10px; font-size: 11px; }
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        th { background: #f8f9fa; font-weight: 600; color: #333; position: sticky; top: 0; white-space: nowrap; }
        th.check-col { width: 40px; text-align: center; }
        td.check-col { text-align: center; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }
        .badge-primary { background: #cce5ff; color: #004085; }
        .remark-text { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; color: #333; }
        .remark-text:hover { color: #667eea; text-decoration: underline; }
        .action-btns { display: flex; gap: 6px; white-space: nowrap; }
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { padding: 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; line-height: 1; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px); }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 10px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 6px; color: #333; font-size: 14px; }
        .form-control {
            width: 100%; padding: 10px 15px; border: 2px solid #e9ecef;
            border-radius: 8px; font-size: 14px; transition: border-color 0.3s;
        }
        .form-control:focus { outline: none; border-color: #667eea; }
        textarea.form-control { min-height: 60px; resize: vertical; }
        select.form-control { appearance: auto; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-hint { font-size: 12px; color: #888; margin-top: 4px; }
        /* Table selector */
        .table-selector { border: 2px solid #e9ecef; border-radius: 8px; max-height: 200px; overflow-y: auto; padding: 8px; }
        .table-selector label { display: flex; align-items: center; padding: 4px 8px; cursor: pointer; border-radius: 4px; font-size: 13px; font-weight: normal; }
        .table-selector label:hover { background: #f8f9fa; }
        .table-selector label input { margin-right: 8px; }
        .table-select-actions { display: flex; gap: 8px; margin-bottom: 8px; }
        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 20px; }
        .pagination button { padding: 8px 12px; border: 1px solid #e9ecef; background: white; cursor: pointer; border-radius: 4px; font-size: 13px; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination .page-info { font-size: 13px; color: #666; margin: 0 10px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.5; }
        /* Toast */
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; z-index: 3000; animation: slideIn 0.3s ease; max-width: 400px; }
        .toast.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .toast.error { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        /* Detail grid */
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .detail-item { background: #f8f9fa; padding: 12px; border-radius: 6px; }
        .detail-item.full { grid-column: 1 / -1; }
        .detail-label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .detail-value { font-size: 14px; font-weight: 500; color: #333; word-break: break-all; }
        /* Switch toggle */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 22px; transition: 0.3s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .switch input:checked + .slider { background: #667eea; }
        .switch input:checked + .slider:before { transform: translateX(18px); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>数据库备份管理</h1>
        <p>Database Backup Management - 数据安全保障</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('backup')">备份管理</div>
        <div class="tab" onclick="switchTab('strategy')">备份策略</div>
    </div>

    <!-- ============ 备份管理面板 ============ -->
    <div class="tab-panel active" id="panelBackup">
        <div class="stats-bar" id="statsBar">
            <div class="stat-item"><div class="stat-value" id="statDatabase">-</div><div class="stat-label">数据库</div></div>
            <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">备份总数</div></div>
            <div class="stat-item"><div class="stat-value" id="statSuccess">0</div><div class="stat-label">成功</div></div>
            <div class="stat-item"><div class="stat-value" id="statFailed">0</div><div class="stat-label">失败</div></div>
            <div class="stat-item"><div class="stat-value" id="statRunning">0</div><div class="stat-label">运行中</div></div>
            <div class="stat-item"><div class="stat-value" id="statTotalSize">0</div><div class="stat-label">总占用空间</div></div>
        </div>

        <!-- Running tasks -->
        <div class="running-panel" id="runningPanel" style="display:none;">
            <h3><span class="dot"></span> 运行中的任务</h3>
            <div id="runningTasksList"></div>
        </div>

        <div class="content">
            <div class="toolbar">
                <h2>备份记录</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showBackupModal()">立即备份</button>
                    <button class="btn btn-info" onclick="loadList()">刷新</button>
                    <button class="btn btn-danger" id="btnBatchDelete" onclick="batchDelete()" disabled>批量删除</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr>
                        <th class="check-col"><input type="checkbox" id="checkAll" onchange="toggleCheckAll()"></th>
                        <th>ID</th><th>文件名</th><th>模式</th><th>文件大小</th><th>表/记录</th>
                        <th>进度</th><th>耗时</th><th>状态</th><th>保护</th><th>备注</th><th>创建时间</th><th>操作</th>
                    </tr></thead>
                    <tbody id="backupList">
                        <tr><td colspan="13" style="text-align:center;padding:60px;">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- ============ 备份策略面板 ============ -->
    <div class="tab-panel" id="panelStrategy">
        <div class="content">
            <div class="toolbar">
                <h2>备份策略</h2>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showStrategyModal()">新建策略</button>
                    <button class="btn btn-info" onclick="loadStrategyList()">刷新</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr>
                        <th>ID</th><th>策略名称</th><th>备份模式</th><th>调度周期</th>
                        <th>滚动备份</th><th>启用</th><th>上次执行</th><th>创建时间</th><th>操作</th>
                    </tr></thead>
                    <tbody id="strategyList">
                        <tr><td colspan="9" style="text-align:center;padding:60px;">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="strategyPagination"></div>
        </div>
    </div>
</div>

<!-- ============ 备份弹窗 ============ -->
<div class="modal" id="backupModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>执行数据库备份</h3>
            <button class="modal-close" onclick="hideModal('backupModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>备份模式</label>
                <select class="form-control" id="backupMode" onchange="onBackupModeChange()">
                    <option value="FULL">全量备份（所有表）</option>
                    <option value="TABLES">指定表备份</option>
                </select>
            </div>
            <div class="form-group" id="tableSelectGroup" style="display:none;">
                <label>选择备份的表</label>
                <div class="table-select-actions">
                    <button class="btn btn-sm btn-info" onclick="selectAllTables(true)">全选</button>
                    <button class="btn btn-sm btn-secondary" onclick="selectAllTables(false)">取消全选</button>
                </div>
                <div class="table-selector" id="tableSelector">加载中...</div>
            </div>
            <div class="form-group">
                <label>备注说明（可选）</label>
                <textarea class="form-control" id="backupRemark" placeholder="请输入备注说明"></textarea>
            </div>
            <div style="background:#fff3cd;padding:12px;border-radius:8px;font-size:13px;color:#856404;">
                <strong>提示：</strong>备份将异步执行，您可以在运行中的任务面板实时查看进度，支持暂停和停止操作。
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('backupModal')">取消</button>
            <button class="btn btn-primary" onclick="executeBackup()">开始备份</button>
        </div>
    </div>
</div>

<!-- ============ 备注编辑弹窗 ============ -->
<div class="modal" id="remarkModal">
    <div class="modal-content" style="max-width:450px;">
        <div class="modal-header">
            <h3>编辑备注</h3>
            <button class="modal-close" onclick="hideModal('remarkModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="remarkId">
            <div class="form-group">
                <label>备注说明</label>
                <textarea class="form-control" id="remarkText" placeholder="请输入备注说明"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('remarkModal')">取消</button>
            <button class="btn btn-primary" onclick="saveRemark()">保存</button>
        </div>
    </div>
</div>

<!-- ============ 详情弹窗 ============ -->
<div class="modal" id="detailModal">
    <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
            <h3>备份详情</h3>
            <button class="modal-close" onclick="hideModal('detailModal')">&times;</button>
        </div>
        <div class="modal-body" id="detailBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('detailModal')">关闭</button>
        </div>
    </div>
</div>

<!-- ============ 策略编辑弹窗 ============ -->
<div class="modal" id="strategyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="strategyModalTitle">新建策略</h3>
            <button class="modal-close" onclick="hideModal('strategyModal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="strategyId">
            <div class="form-group">
                <label>策略名称</label>
                <input type="text" class="form-control" id="strategyName" placeholder="如：每日全量备份">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>备份模式</label>
                    <select class="form-control" id="strategyMode" onchange="onStrategyModeChange()">
                        <option value="FULL">全量备份</option>
                        <option value="TABLES">指定表备份</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>调度周期</label>
                    <select class="form-control" id="strategySchedule">
                        <option value="ONCE">单次（手动触发）</option>
                        <option value="HOURLY">每小时</option>
                        <option value="DAILY" selected>每天</option>
                        <option value="WEEKLY">每周</option>
                    </select>
                </div>
            </div>
            <div class="form-group" id="strategyTableGroup" style="display:none;">
                <label>选择备份的表</label>
                <div class="table-select-actions">
                    <button class="btn btn-sm btn-info" onclick="selectAllStrategyTables(true)">全选</button>
                    <button class="btn btn-sm btn-secondary" onclick="selectAllStrategyTables(false)">取消全选</button>
                </div>
                <div class="table-selector" id="strategyTableSelector">加载中...</div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>启用滚动备份</label>
                    <div style="padding-top:8px;">
                        <label class="switch">
                            <input type="checkbox" id="strategyRolling" onchange="onRollingToggle()">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size:12px;color:#888;margin-left:8px;">超出保留数量自动清理旧备份</span>
                    </div>
                </div>
                <div class="form-group" id="rollingKeepGroup" style="display:none;">
                    <label>滚动保留数量</label>
                    <input type="number" class="form-control" id="strategyMaxKeep" value="10" min="1">
                    <div class="form-hint">保留最新的N份备份，超出后自动删除（永久存储的不受影响）</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>启用状态</label>
                    <div style="padding-top:8px;">
                        <label class="switch">
                            <input type="checkbox" id="strategyEnable" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="form-group"></div>
            </div>
            <div class="form-group">
                <label>备注</label>
                <textarea class="form-control" id="strategyRemark" placeholder="可选"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('strategyModal')">取消</button>
            <button class="btn btn-primary" onclick="saveStrategy()">保存</button>
        </div>
    </div>
</div>

<script>
//<#noparse>
const API_BASE = '/db/backup';
let currentPage = 1, pageSize = 10, selectedIds = new Set();
let strategyPage = 1, strategyPageSize = 10;
let allDbTables = [];
let progressTimer = null;

// ========================
// 初始化
// ========================
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadList();
    startProgressPolling();
    loadDbTables();
});

// ========================
// Tab 切换
// ========================
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', (tab === 'backup' ? i === 0 : i === 1));
    });
    document.getElementById('panelBackup').classList.toggle('active', tab === 'backup');
    document.getElementById('panelStrategy').classList.toggle('active', tab === 'strategy');
    if (tab === 'strategy') loadStrategyList();
}

// ========================
// 统计
// ========================
async function loadStats() {
    try {
        const res = await fetch(API_BASE + '/stats');
        const data = await res.json();
        if (data.code === 0) {
            const s = data.stats;
            document.getElementById('statDatabase').textContent = s.database || '-';
            document.getElementById('statTotal').textContent = s.total || 0;
            document.getElementById('statSuccess').textContent = s.success || 0;
            document.getElementById('statFailed').textContent = s.failed || 0;
            document.getElementById('statRunning').textContent = s.running || 0;
            document.getElementById('statTotalSize').textContent = formatSize(s.totalSize || 0);
        }
    } catch(e) { console.error('Load stats failed:', e); }
}

// ========================
// 加载数据库表列表
// ========================
async function loadDbTables() {
    try {
        const res = await fetch(API_BASE + '/tables');
        const data = await res.json();
        if (data.code === 0) {
            allDbTables = data.tables || [];
        }
    } catch(e) { console.error('Load tables failed:', e); }
}

// ========================
// 运行中任务轮询
// ========================
function startProgressPolling() {
    if (progressTimer) clearInterval(progressTimer);
    progressTimer = setInterval(pollRunningTasks, 2000);
    pollRunningTasks();
}

async function pollRunningTasks() {
    try {
        const res = await fetch(API_BASE + '/task/running');
        const data = await res.json();
        if (data.code === 0) {
            renderRunningTasks(data.tasks || []);
        }
    } catch(e) { /* silent */ }
}

function renderRunningTasks(tasks) {
    const panel = document.getElementById('runningPanel');
    const container = document.getElementById('runningTasksList');
    if (!tasks || tasks.length === 0) {
        panel.style.display = 'none';
        return;
    }
    panel.style.display = 'block';
    container.innerHTML = tasks.map(t => {
        const pct = t.progress || 0;
        const pausedClass = t.paused ? ' paused' : '';
        const statusText = t.paused ? '已暂停' : '备份中';
        const currentInfo = t.currentTable ? ' - 正在备份: ' + escapeHtml(t.currentTable) : '';
        const tablesInfo = (t.completedTables || 0) + '/' + (t.totalTables || '?') + ' 表';
        return '<div class="task-card">' +
            '<div class="task-info">' +
                '<div class="task-name">' + escapeHtml(t.filename || '') + '</div>' +
                '<div class="task-meta">' + renderModeLabel(t.mode) + ' | ' + tablesInfo + ' | ' + statusText + currentInfo + '</div>' +
            '</div>' +
            '<div class="progress-bar-container">' +
                '<div class="progress-bar-outer">' +
                    '<div class="progress-bar-inner' + pausedClass + '" style="width:' + pct + '%"></div>' +
                    '<div class="progress-text">' + pct + '%</div>' +
                '</div>' +
            '</div>' +
            '<div class="task-controls">' +
                (t.paused
                    ? '<button class="btn btn-success btn-xs" onclick="resumeTask(' + t.id + ')">恢复</button>'
                    : '<button class="btn btn-warning btn-xs" onclick="pauseTask(' + t.id + ')">暂停</button>') +
                '<button class="btn btn-danger btn-xs" onclick="stopTask(' + t.id + ')">停止</button>' +
            '</div>' +
        '</div>';
    }).join('');
}

// ========================
// 任务控制
// ========================
async function pauseTask(id) {
    try {
        const res = await fetch(API_BASE + '/task/pause/' + id, {method:'POST'});
        const data = await res.json();
        showToast(data.code === 0 ? '任务已暂停' : (data.msg || '操作失败'), data.code === 0 ? 'success' : 'error');
        pollRunningTasks();
    } catch(e) { showToast('操作失败', 'error'); }
}

async function resumeTask(id) {
    try {
        const res = await fetch(API_BASE + '/task/resume/' + id, {method:'POST'});
        const data = await res.json();
        showToast(data.code === 0 ? '任务已恢复' : (data.msg || '操作失败'), data.code === 0 ? 'success' : 'error');
        pollRunningTasks();
    } catch(e) { showToast('操作失败', 'error'); }
}

async function stopTask(id) {
    if (!confirm('确定要停止此备份任务吗？已完成的部分将保留为不完整备份。')) return;
    try {
        const res = await fetch(API_BASE + '/task/stop/' + id, {method:'POST'});
        const data = await res.json();
        showToast(data.code === 0 ? '任务已停止' : (data.msg || '操作失败'), data.code === 0 ? 'success' : 'error');
        pollRunningTasks();
        setTimeout(() => { loadList(); loadStats(); }, 1000);
    } catch(e) { showToast('操作失败', 'error'); }
}

// ========================
// 备份列表
// ========================
async function loadList() {
    const tbody = document.getElementById('backupList');
    tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;padding:40px;">加载中...</td></tr>';
    try {
        const res = await fetch(API_BASE + '/list?page=' + currentPage + '&limit=' + pageSize);
        const data = await res.json();
        if (data.code === 0 && data.page) {
            renderList(data.page.list || [], data.page.totalCount || 0, data.page.totalPage || 0);
        } else {
            tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;padding:40px;">加载失败</td></tr>';
        }
    } catch(e) {
        console.error('Load list failed:', e);
        tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;padding:40px;">加载失败</td></tr>';
    }
}

function renderList(list, total, totalPages) {
    const tbody = document.getElementById('backupList');
    selectedIds.clear();
    updateBatchButton();
    document.getElementById('checkAll').checked = false;
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13"><div class="empty-state"><div class="empty-state-icon">&#128451;</div><h3>暂无备份记录</h3><p>点击"立即备份"按钮创建第一个数据库备份</p></div></td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }
    tbody.innerHTML = list.map(function(item) {
        var progressHtml = '';
        if (item.status === 3 || item.status === 4 || item.status === 0) {
            var pct = item.progress || 0;
            progressHtml = '<div class="progress-bar-outer" style="height:14px;min-width:80px;">' +
                '<div class="progress-bar-inner" style="width:' + pct + '%"></div>' +
                '<div class="progress-text" style="font-size:10px;line-height:14px;">' + pct + '%</div></div>';
        } else if (item.status === 1) {
            progressHtml = '<span style="color:#28a745;font-weight:600;">100%</span>';
        } else {
            progressHtml = '-';
        }
        var tablesRecords = (item.tables != null ? item.tables : '-') + ' / ' + (item.records != null ? formatNumber(item.records) : '-');
        return '<tr>' +
            '<td class="check-col"><input type="checkbox" value="' + item.id + '" onchange="toggleCheck(' + item.id + ')" ' + (selectedIds.has(item.id) ? 'checked' : '') + '></td>' +
            '<td>' + item.id + '</td>' +
            '<td><code style="font-size:12px;">' + escapeHtml(item.filename || '-') + '</code></td>' +
            '<td>' + renderModeLabel(item.mode) + '</td>' +
            '<td>' + (item.filesize ? formatSize(item.filesize) : '-') + '</td>' +
            '<td>' + tablesRecords + '</td>' +
            '<td>' + progressHtml + '</td>' +
            '<td>' + (item.duration != null && item.status === 1 ? formatDuration(item.duration) : '-') + '</td>' +
            '<td>' + renderStatus(item.status) + '</td>' +
            '<td>' + renderPermanentBadge(item.permanent, item.id) + '</td>' +
            '<td><span class="remark-text" onclick="editRemark(' + item.id + ', \'' + escapeAttr(item.remark || '') + '\')" title="' + escapeAttr(item.remark || '点击添加备注') + '">' +
                (item.remark ? escapeHtml(item.remark) : '<span style="color:#aaa;">点击添加</span>') + '</span></td>' +
            '<td>' + formatTime(item.createTime) + '</td>' +
            '<td><div class="action-btns">' +
                '<button class="btn btn-info btn-sm" onclick="showDetail(' + item.id + ')">详情</button>' +
                (item.status === 1 ? '<button class="btn btn-success btn-sm" onclick="downloadBackup(' + item.id + ')">下载</button>' : '') +
                '<button class="btn btn-danger btn-sm" onclick="deleteBackup(' + item.id + ')">删除</button>' +
            '</div></td></tr>';
    }).join('');
    renderPagination(total, totalPages);
}

function renderPagination(total, totalPages) {
    var container = document.getElementById('pagination');
    if (totalPages <= 1) {
        container.innerHTML = total > 0 ? '<span class="page-info">共 ' + total + ' 条记录</span>' : '';
        return;
    }
    var html = '<span class="page-info">共 ' + total + ' 条</span>';
    html += '<button ' + (currentPage === 1 ? 'disabled' : '') + ' onclick="goToPage(1)">首页</button>';
    html += '<button ' + (currentPage === 1 ? 'disabled' : '') + ' onclick="goToPage(' + (currentPage-1) + ')">上一页</button>';
    var start = Math.max(1, currentPage - 2);
    var end = Math.min(totalPages, start + 4);
    start = Math.max(1, end - 4);
    for (var i = start; i <= end; i++) {
        html += '<button class="' + (currentPage === i ? 'active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</button>';
    }
    html += '<button ' + (currentPage === totalPages ? 'disabled' : '') + ' onclick="goToPage(' + (currentPage+1) + ')">下一页</button>';
    html += '<button ' + (currentPage === totalPages ? 'disabled' : '') + ' onclick="goToPage(' + totalPages + ')">末页</button>';
    container.innerHTML = html;
}

function goToPage(page) { currentPage = page; loadList(); }

// ========================
// 执行备份
// ========================
function showBackupModal() {
    document.getElementById('backupRemark').value = '';
    document.getElementById('backupMode').value = 'FULL';
    onBackupModeChange();
    showModal('backupModal');
}

function onBackupModeChange() {
    var mode = document.getElementById('backupMode').value;
    var group = document.getElementById('tableSelectGroup');
    group.style.display = mode === 'TABLES' ? 'block' : 'none';
    if (mode === 'TABLES') renderTableSelector('tableSelector', allDbTables, []);
}

function renderTableSelector(containerId, tables, selected) {
    var container = document.getElementById(containerId);
    if (!tables || tables.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">暂无表信息</div>';
        return;
    }
    container.innerHTML = tables.map(function(t) {
        var checked = selected.indexOf(t) >= 0 ? ' checked' : '';
        return '<label><input type="checkbox" value="' + escapeHtml(t) + '"' + checked + '> ' + escapeHtml(t) + '</label>';
    }).join('');
}

function selectAllTables(checked) {
    document.querySelectorAll('#tableSelector input[type="checkbox"]').forEach(function(cb) { cb.checked = checked; });
}

function getSelectedTables(containerId) {
    var result = [];
    document.querySelectorAll('#' + containerId + ' input[type="checkbox"]:checked').forEach(function(cb) { result.push(cb.value); });
    return result;
}

async function executeBackup() {
    var mode = document.getElementById('backupMode').value;
    var remark = document.getElementById('backupRemark').value.trim();
    var tables = null;
    if (mode === 'TABLES') {
        var sel = getSelectedTables('tableSelector');
        if (sel.length === 0) { showToast('请至少选择一张表', 'error'); return; }
        tables = sel.join(',');
    }
    hideModal('backupModal');
    try {
        var res = await fetch(API_BASE + '/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({remark: remark, mode: mode, tables: tables})
        });
        var data = await res.json();
        if (data.code === 0) {
            showToast('备份任务已提交，请在任务面板查看进度');
            loadList(); loadStats(); pollRunningTasks();
        } else {
            showToast(data.msg || '提交失败', 'error');
        }
    } catch(e) { showToast('请求失败: ' + e.message, 'error'); }
}

// ========================
// 备份操作
// ========================
function downloadBackup(id) { window.open(API_BASE + '/download/' + id, '_blank'); }

function editRemark(id, remark) {
    document.getElementById('remarkId').value = id;
    document.getElementById('remarkText').value = remark;
    showModal('remarkModal');
}

async function saveRemark() {
    var id = document.getElementById('remarkId').value;
    var remark = document.getElementById('remarkText').value.trim();
    try {
        var res = await fetch(API_BASE + '/remark', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: parseInt(id), remark: remark})
        });
        var data = await res.json();
        if (data.code === 0) { showToast('备注已更新'); hideModal('remarkModal'); loadList(); }
        else { showToast(data.msg || '更新失败', 'error'); }
    } catch(e) { showToast('更新失败', 'error'); }
}

async function showDetail(id) {
    try {
        var res = await fetch(API_BASE + '/info/' + id);
        var data = await res.json();
        if (data.code === 0 && data.info) {
            var info = data.info;
            document.getElementById('detailBody').innerHTML =
                '<div class="detail-grid">' +
                    '<div class="detail-item"><div class="detail-label">ID</div><div class="detail-value">' + info.id + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">状态</div><div class="detail-value">' + renderStatus(info.status) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">备份模式</div><div class="detail-value">' + renderModeLabel(info.mode) + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">进度</div><div class="detail-value">' + (info.progress != null ? info.progress + '%' : '-') + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">存储保护</div><div class="detail-value">' + (info.permanent ? '<span class="badge badge-warning">永久存储</span>' : '普通（可被滚动清理）') + '</div></div>' +
                    '<div class="detail-item full"><div class="detail-label">文件名</div><div class="detail-value">' + escapeHtml(info.filename || '-') + '</div></div>' +
                    '<div class="detail-item full"><div class="detail-label">文件路径</div><div class="detail-value">' + escapeHtml(info.filepath || '-') + '</div></div>' +
                    (info.backupTables ? '<div class="detail-item full"><div class="detail-label">备份表</div><div class="detail-value">' + escapeHtml(info.backupTables) + '</div></div>' : '') +
                    '<div class="detail-item"><div class="detail-label">数据库</div><div class="detail-value">' + escapeHtml(info.database || '-') + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">文件大小</div><div class="detail-value">' + (info.filesize ? formatSize(info.filesize) : '-') + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">备份表数量</div><div class="detail-value">' + (info.tables != null ? info.tables + ' 张' : '-') + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">备份记录数</div><div class="detail-value">' + (info.records != null ? formatNumber(info.records) + ' 条' : '-') + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">耗时</div><div class="detail-value">' + (info.duration != null ? formatDuration(info.duration) : '-') + '</div></div>' +
                    '<div class="detail-item"><div class="detail-label">创建时间</div><div class="detail-value">' + formatTime(info.createTime) + '</div></div>' +
                    '<div class="detail-item full"><div class="detail-label">备注</div><div class="detail-value">' + (info.remark ? escapeHtml(info.remark) : '<span style="color:#aaa;">无</span>') + '</div></div>' +
                    (info.error ? '<div class="detail-item full"><div class="detail-label">错误信息</div><div class="detail-value" style="color:#dc3545;">' + escapeHtml(info.error) + '</div></div>' : '') +
                '</div>';
            showModal('detailModal');
        } else { showToast('获取详情失败', 'error'); }
    } catch(e) { showToast('获取详情失败', 'error'); }
}

async function deleteBackup(id) {
    if (!confirm('确定要删除此备份吗？备份文件也将被删除，此操作不可恢复！')) return;
    try {
        var res = await fetch(API_BASE + '/delete/' + id, {method:'POST'});
        var data = await res.json();
        if (data.code === 0) { showToast('删除成功'); loadList(); loadStats(); }
        else { showToast(data.msg || '删除失败', 'error'); }
    } catch(e) { showToast('删除失败', 'error'); }
}

async function batchDelete() {
    if (selectedIds.size === 0) { showToast('请先选择要删除的备份', 'error'); return; }
    if (!confirm('确定要删除选中的 ' + selectedIds.size + ' 个备份吗？此操作不可恢复！')) return;
    try {
        var res = await fetch(API_BASE + '/deleteBatch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(Array.from(selectedIds))
        });
        var data = await res.json();
        if (data.code === 0) { showToast('批量删除成功'); selectedIds.clear(); loadList(); loadStats(); }
        else { showToast(data.msg || '删除失败', 'error'); }
    } catch(e) { showToast('删除失败', 'error'); }
}

function toggleCheckAll() {
    var checked = document.getElementById('checkAll').checked;
    document.querySelectorAll('#backupList input[type="checkbox"]').forEach(function(cb) {
        cb.checked = checked;
        var id = parseInt(cb.value);
        if (checked) selectedIds.add(id); else selectedIds.delete(id);
    });
    updateBatchButton();
}
function toggleCheck(id) {
    if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
    updateBatchButton();
}
function updateBatchButton() {
    var btn = document.getElementById('btnBatchDelete');
    btn.disabled = selectedIds.size === 0;
    btn.textContent = selectedIds.size > 0 ? '批量删除 (' + selectedIds.size + ')' : '批量删除';
}

// ========================
// 策略管理
// ========================
async function loadStrategyList() {
    var tbody = document.getElementById('strategyList');
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">加载中...</td></tr>';
    try {
        var res = await fetch(API_BASE + '/strategy/list?page=' + strategyPage + '&limit=' + strategyPageSize);
        var data = await res.json();
        if (data.code === 0 && data.page) {
            renderStrategyList(data.page.list || [], data.page.totalCount || 0, data.page.totalPage || 0);
        } else {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">加载失败</td></tr>';
        }
    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;">加载失败</td></tr>';
    }
}

function renderStrategyList(list, total, totalPages) {
    var tbody = document.getElementById('strategyList');
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">&#128196;</div><h3>暂无备份策略</h3><p>点击"新建策略"按钮创建自动备份策略</p></div></td></tr>';
        document.getElementById('strategyPagination').innerHTML = '';
        return;
    }
    tbody.innerHTML = list.map(function(item) {
        return '<tr>' +
            '<td>' + item.id + '</td>' +
            '<td><strong>' + escapeHtml(item.name || '-') + '</strong></td>' +
            '<td>' + renderModeLabel(item.mode) + '</td>' +
            '<td>' + renderScheduleLabel(item.schedule) + '</td>' +
            '<td>' + renderRollingLabel(item.rollingEnabled, item.maxKeep) + '</td>' +
            '<td>' + (item.enable ? '<span class="badge badge-success">启用</span>' : '<span class="badge badge-secondary">禁用</span>') + '</td>' +
            '<td>' + formatTime(item.lastRunTime) + '</td>' +
            '<td>' + formatTime(item.createTime) + '</td>' +
            '<td><div class="action-btns">' +
                '<button class="btn btn-success btn-sm" onclick="executeStrategy(' + item.id + ')">执行</button>' +
                '<button class="btn btn-info btn-sm" onclick="editStrategy(' + item.id + ')">编辑</button>' +
                '<button class="btn btn-danger btn-sm" onclick="deleteStrategy(' + item.id + ')">删除</button>' +
            '</div></td></tr>';
    }).join('');

    // 策略分页
    var container = document.getElementById('strategyPagination');
    if (totalPages <= 1) {
        container.innerHTML = total > 0 ? '<span class="page-info">共 ' + total + ' 条记录</span>' : '';
        return;
    }
    var html = '<span class="page-info">共 ' + total + ' 条</span>';
    html += '<button ' + (strategyPage === 1 ? 'disabled' : '') + ' onclick="goToStrategyPage(1)">首页</button>';
    html += '<button ' + (strategyPage === 1 ? 'disabled' : '') + ' onclick="goToStrategyPage(' + (strategyPage-1) + ')">上一页</button>';
    var start = Math.max(1, strategyPage - 2);
    var end = Math.min(totalPages, start + 4);
    start = Math.max(1, end - 4);
    for (var i = start; i <= end; i++) {
        html += '<button class="' + (strategyPage === i ? 'active' : '') + '" onclick="goToStrategyPage(' + i + ')">' + i + '</button>';
    }
    html += '<button ' + (strategyPage === totalPages ? 'disabled' : '') + ' onclick="goToStrategyPage(' + (strategyPage+1) + ')">下一页</button>';
    html += '<button ' + (strategyPage === totalPages ? 'disabled' : '') + ' onclick="goToStrategyPage(' + totalPages + ')">末页</button>';
    container.innerHTML = html;
}

function goToStrategyPage(page) { strategyPage = page; loadStrategyList(); }

function showStrategyModal(data) {
    document.getElementById('strategyModalTitle').textContent = data ? '编辑策略' : '新建策略';
    document.getElementById('strategyId').value = data ? data.id : '';
    document.getElementById('strategyName').value = data ? (data.name || '') : '';
    document.getElementById('strategyMode').value = data ? (data.mode || 'FULL') : 'FULL';
    document.getElementById('strategySchedule').value = data ? (data.schedule || 'DAILY') : 'DAILY';
    document.getElementById('strategyRolling').checked = data ? data.rollingEnabled : false;
    document.getElementById('strategyMaxKeep').value = data ? (data.maxKeep || 10) : 10;
    document.getElementById('rollingKeepGroup').style.display = (data && data.rollingEnabled) ? 'block' : 'none';
    document.getElementById('strategyEnable').checked = data ? data.enable : true;
    document.getElementById('strategyRemark').value = data ? (data.remark || '') : '';
    onStrategyModeChange(data ? (data.tables || '') : '');
    showModal('strategyModal');
}

function onStrategyModeChange(selectedTables) {
    var mode = document.getElementById('strategyMode').value;
    var group = document.getElementById('strategyTableGroup');
    group.style.display = mode === 'TABLES' ? 'block' : 'none';
    if (mode === 'TABLES') {
        var selected = [];
        if (typeof selectedTables === 'string' && selectedTables) {
            selected = selectedTables.split(',').map(function(s) { return s.trim(); });
        }
        renderTableSelector('strategyTableSelector', allDbTables, selected);
    }
}

function selectAllStrategyTables(checked) {
    document.querySelectorAll('#strategyTableSelector input[type="checkbox"]').forEach(function(cb) { cb.checked = checked; });
}

async function saveStrategy() {
    var id = document.getElementById('strategyId').value;
    var name = document.getElementById('strategyName').value.trim();
    if (!name) { showToast('请输入策略名称', 'error'); return; }
    var mode = document.getElementById('strategyMode').value;
    var tables = null;
    if (mode === 'TABLES') {
        var sel = getSelectedTables('strategyTableSelector');
        if (sel.length === 0) { showToast('请至少选择一张表', 'error'); return; }
        tables = sel.join(',');
    }
    var rollingEnabled = document.getElementById('strategyRolling').checked;
    var payload = {
        name: name,
        mode: mode,
        tables: tables,
        schedule: document.getElementById('strategySchedule').value,
        rollingEnabled: rollingEnabled,
        maxKeep: rollingEnabled ? (parseInt(document.getElementById('strategyMaxKeep').value) || 10) : 0,
        enable: document.getElementById('strategyEnable').checked,
        remark: document.getElementById('strategyRemark').value.trim()
    };
    if (id) payload.id = parseInt(id);
    try {
        var res = await fetch(API_BASE + '/strategy/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        var data = await res.json();
        if (data.code === 0) {
            showToast('策略保存成功');
            hideModal('strategyModal');
            loadStrategyList();
        } else { showToast(data.msg || '保存失败', 'error'); }
    } catch(e) { showToast('保存失败', 'error'); }
}

async function editStrategy(id) {
    try {
        var res = await fetch(API_BASE + '/strategy/info/' + id);
        var data = await res.json();
        if (data.code === 0 && data.info) {
            showStrategyModal(data.info);
        } else { showToast('获取策略信息失败', 'error'); }
    } catch(e) { showToast('获取策略信息失败', 'error'); }
}

async function deleteStrategy(id) {
    if (!confirm('确定要删除此策略吗？')) return;
    try {
        var res = await fetch(API_BASE + '/strategy/delete/' + id, {method:'POST'});
        var data = await res.json();
        if (data.code === 0) { showToast('删除成功'); loadStrategyList(); }
        else { showToast(data.msg || '删除失败', 'error'); }
    } catch(e) { showToast('删除失败', 'error'); }
}

async function executeStrategy(id) {
    if (!confirm('确定要立即执行此策略吗？')) return;
    try {
        var res = await fetch(API_BASE + '/strategy/execute/' + id, {method:'POST'});
        var data = await res.json();
        if (data.code === 0) {
            showToast('策略执行已提交');
            loadStrategyList();
            switchTab('backup');
            setTimeout(function() { pollRunningTasks(); loadList(); loadStats(); }, 500);
        } else { showToast(data.msg || '执行失败', 'error'); }
    } catch(e) { showToast('执行失败', 'error'); }
}

// ========================
// 渲染辅助
// ========================
function renderStatus(status) {
    switch(status) {
        case 0: return '<span class="badge badge-secondary">等待中</span>';
        case 1: return '<span class="badge badge-success">成功</span>';
        case 2: return '<span class="badge badge-danger">失败</span>';
        case 3: return '<span class="badge badge-primary">进行中</span>';
        case 4: return '<span class="badge badge-warning">已暂停</span>';
        case 5: return '<span class="badge badge-info">已停止</span>';
        default: return '<span class="badge badge-secondary">未知</span>';
    }
}

function renderModeLabel(mode) {
    switch(mode) {
        case 'FULL': return '<span class="badge badge-info">全量</span>';
        case 'TABLES': return '<span class="badge badge-warning">指定表</span>';
        default: return '<span class="badge badge-secondary">' + escapeHtml(mode || '-') + '</span>';
    }
}

function renderScheduleLabel(schedule) {
    switch(schedule) {
        case 'ONCE': return '手动触发';
        case 'HOURLY': return '每小时';
        case 'DAILY': return '每天';
        case 'WEEKLY': return '每周';
        default: return schedule || '-';
    }
}

function renderPermanentBadge(permanent, id) {
    if (permanent) {
        return '<span class="badge badge-warning" style="cursor:pointer;" onclick="togglePermanent(' + id + ')" title="点击取消永久存储">永久</span>';
    }
    return '<span style="color:#aaa;cursor:pointer;font-size:12px;" onclick="togglePermanent(' + id + ')" title="点击设为永久存储">普通</span>';
}

function renderRollingLabel(rollingEnabled, maxKeep) {
    if (rollingEnabled) {
        return '<span class="badge badge-info">保留 ' + (maxKeep || 0) + ' 份</span>';
    }
    return '<span style="color:#aaa;">未启用</span>';
}

async function togglePermanent(id) {
    try {
        var res = await fetch(API_BASE + '/togglePermanent/' + id, {method:'POST'});
        var data = await res.json();
        if (data.code === 0) {
            showToast(data.msg);
            loadList();
        } else {
            showToast(data.msg || '操作失败', 'error');
        }
    } catch(e) { showToast('操作失败', 'error'); }
}

function onRollingToggle() {
    var checked = document.getElementById('strategyRolling').checked;
    document.getElementById('rollingKeepGroup').style.display = checked ? 'block' : 'none';
}

// ========================
// Modal 操作
// ========================
function showModal(id) { document.getElementById(id).classList.add('show'); }
function hideModal(id) { document.getElementById(id).classList.remove('show'); }

// ========================
// Toast
// ========================
function showToast(msg, type) {
    type = type || 'success';
    var toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 3000);
}

// ========================
// 工具函数
// ========================
function formatSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    var units = ['B','KB','MB','GB','TB'];
    var i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(i > 0 ? 2 : 0) + ' ' + units[i];
}
function formatDuration(ms) {
    if (ms < 1000) return ms + ' ms';
    if (ms < 60000) return (ms / 1000).toFixed(1) + ' 秒';
    return (ms / 60000).toFixed(1) + ' 分钟';
}
function formatNumber(num) {
    if (num == null) return '-';
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
function formatTime(timestamp) {
    if (!timestamp) return '-';
    return new Date(timestamp).toLocaleString('zh-CN');
}
function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
}
function escapeAttr(str) {
    if (!str) return '';
    return String(str).replace(/'/g, "\\'").replace(/"/g, '\\"');
}
//</#noparse>
</script>
</body>
</html>
